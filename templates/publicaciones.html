<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App</title>
    <script>
        function buscarUsuario() {
            let input = document.getElementById("searchUser").value;
            if (input.length > 1) {
                fetch(`/buscar_usuarios?query=${input}`)
                .then(response => response.json())
                .then(data => {
                    let resultados = document.getElementById("resultadosBusqueda");
                    resultados.innerHTML = "";
                    data.forEach(user => {
                        let li = document.createElement("li");
                        li.innerHTML = `<a href="/perfil/${user.id}">${user.username}</a>`;
                        resultados.appendChild(li);
                    });
                });
            }
        }
    </script>
    <link rel="stylesheet" href="{{url_for('static', filename='./CSS/publicaciones.css')}}">    
</head>
<body>
    <div class="barra_s"> <!-- Barra superior -->
        <div class="s1">
            {% if profile_picture %}
            <a href="{{ url_for('perfil', id_usuario=user.id) }}">
                <img src="data:image/png;base64,{{ profile_picture }}" alt="Foto" class="img1">
            </a>
            {% endif %}
        </div>
        <div class="s2">
            <input type="text" id="searchUser" placeholder="Buscar usuario..." onkeyup="buscarUsuario()">
            <br>
            <ul id="resultadosBusqueda"></ul>
        </div>
        <div>
            {% if session['nombre_usuario'] %}
                <a href="{{ url_for('logout') }}">Salir</a>
            {% else %}
                <a href="{{ url_for('inicio') }}">Iniciar sesión</a>
            {% endif %}
        </div>
        
    </div>
    <div class="contenido"> 
        <form action="{{ url_for('crear_publicacion') }}" method="POST" enctype="multipart/form-data">
            <p>¿Qué estás pensando {{ user.username }}?</p>
            <textarea name="contenido" placeholder="Escribe tu publicación..." required></textarea><br><br>
            <label for="foto_publicacion" class="label1">Subir archivo</label>
            <input type="file" id="foto_publicacion" name="foto_publicacion" accept="image/*" class="cargar"><br><br>
            <button type="submit">Publicar</button>
        </form>
    </div>
    
    <div class="contenido1"><!-- Contenido -->
        <div class="text1">
            <div class="complemento">
            </div>
            <div class="circulo">
                <img src="{{url_for('static', filename='./Images/logo_pr.png')}}" class="img2">
            </div>    
            <div class="complemento">
                
            </div>
            <br>
        </div>
        <div>
            <ul class="ul">
                {% for publicacion in publicaciones %}
                    {% if publicacion.id_respuesta == None %} 
                        <li class="li1">
                            <p class="p1">
                                {% if publicacion.foto_publicacion %}
                                    <img src="data:image/png;base64,{{ publicacion.foto_publicacion }}" alt="Foto">
                                {% endif %}
                                <a href="{{ url_for('perfil', id_usuario=publicacion.id_usuario) }}">
                                    {{ publicacion.nombre_usuario }} 
                                </a>
                                ‎ ({{ publicacion.fecha }}) <!-- Texto Invisible [u+] -->
                            </p>
                            <div class="publiuser">   
                                <p>{{ publicacion.contenido }}</p>
                            </div> 

                            <div class="likeuser">
                                <div class="respuesta">
                                    <form action="{{ url_for('responder_publicacion', id_publicacion=publicacion.id_publicacion) }}" method="POST">
                                        <textarea name="respuesta" placeholder="Comentar" required></textarea><br>
                                        <button type="submit">Enviar</button>
                                        
                                    </form> 
                                </div>
                                <div class="partelike">
                                    <form action="{{ url_for('likear_publicacion', id_publicacion=publicacion.id_publicacion) }}" method="GET">
                                        {% if publicacion.like %}
                                            <button type="submit" class="btnlike"><img src="{{url_for('static', filename='./Images/like.png')}}" class="img3"></button>
                                        {% else %}
                                            <button type="submit" class="btnlike"><img src="{{url_for('static', filename='./Images/fotounlike.png')}}" class="img3"></button>
                                        {% endif %}
                                        {{ publicacion.cant_likes}}
                                       
                                    </form>    
                                </div>
                            </div>

                            <div> <!-- Respuestas -->
                                {% for respuesta in publicaciones %}
                                {% if respuesta.id_respuesta == publicacion.id_publicacion %}
                                    <li class="li2">
                                        <p class="p1">
                                            <a href="{{ url_for('perfil', id_usuario=respuesta.id_usuario) }}">
                                                {{ respuesta.nombre_usuario }} 
                                            </a> ({{ respuesta.fecha }})
                                        </p>
                                        <div class="publiuser">
                                            <p>{{ respuesta.contenido }}</p>
                                        </div>
                                    </li>

                                    <div class="likeuser1">
                                        <div>
                                            <form action="{{ url_for('likear_publicacion', id_publicacion=respuesta.id_publicacion) }}" method="GET">
                                                {% if respuesta.like %}
                                                    <button type="submit" class="btnlike1">
                                                        <img src="{{ url_for('static', filename='Images/like.png') }}" class="img4">
                                                    </button>
                                                {% else %}
                                                    <button type="submit" class="btnlike1">
                                                        <img src="{{ url_for('static', filename='Images/fotounlike.png') }}" class="img4">
                                                    </button>
                                                {% endif %}
                                            </form>    
                                        </div>
                                        <div>
                                            {{ respuesta.cant_likes }}
                                        </div>
                                    </div>

                                {% endif %}
                            {% endfor %}
                            </div>
    
                            <br>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    </div>
</body>
</html>
